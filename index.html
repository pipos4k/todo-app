<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Todo App</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            background-color: black;
            color: white;
            font-family: Arial, sans-serif;
            padding: 20px;
        }

        .container {
            max-width: 800px;
            margin: 0 auto;
        }

        h1 {
            margin-bottom: 20px;
        }

        .section {
            margin-bottom: 30px;
        }

        .form-group {
            margin-bottom: 15px;
        }

        input {
            width: 100%;
            padding: 10px;
            margin-bottom: 10px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
        }

        button {
            padding: 10px 20px;
            margin: 5px;
            background-color: #333;
            color: white;
            border: 1px solid #555;
            cursor: pointer;
        }

        button:hover {
            background-color: #555;
        }

        .message {
            margin-top: 10px;
            padding: 10px;
            background-color: #333;
            border: 1px solid #555;
        }

        .items-list {
            margin-top: 20px;
        }

        .item {
            padding: 10px;
            margin: 5px 0;
            background-color: #333;
            border: 1px solid #555;
        }

        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>Todo App</h1>

        <!-- Authentication Section -->
        <div id="authSection" class="section">
            <h2>Register</h2>
            <div class="form-group">
                <input type="email" id="registerEmail" placeholder="Email">
                <input type="password" id="registerPassword" placeholder="Password">
                <button onclick="register()">Create Account</button>
            </div>

            <h2>Login</h2>
            <div class="form-group">
                <input type="email" id="loginEmail" placeholder="Email">
                <input type="password" id="loginPassword" placeholder="Password">
                <button onclick="login()">Sign In</button>
            </div>
            <div id="authMessage" class="message hidden"></div>
        </div>

        <!-- Todo Management Section (shown after login) -->
        <div id="todoSection" class="section hidden">
            <h2>Todo Items</h2>
            <div id="userInfo" class="message"></div>

            <h3>Create Item</h3>
            <div class="form-group">
                <input type="text" id="itemTitle" placeholder="Title">
                <input type="text" id="itemDescription" placeholder="Description">
                <select id="itemStatus" style="width: 100%; padding: 10px; margin-bottom: 10px; background-color: #333; color: white; border: 1px solid #555;">
                    <option value="ToDo">ToDo</option>
                    <option value="InProgress">InProgress</option>
                    <option value="Done">Done</option>
                </select>
                <button onclick="createItem()">Create Item</button>
            </div>

            <h3>Actions</h3>
            <button onclick="loadItems()">Load Items</button>
            <button onclick="logout()">Logout</button>

            <h3>Sort Items</h3>
            <div class="form-group">
                <select id="sortBy" style="width: 100%; padding: 10px; margin-bottom: 10px; background-color: #333; color: white; border: 1px solid #555;">                
                    <option value="title">Sort by Title</option>
                    <option value="status">Sort by Status</option>
                    <option value="timestamp">Sort by Timestamp</option>
                </select>
                <select id="sortOrder" style="width: 100%; padding: 10px; margin-bottom: 10px; background-color: #333; color: white; border: 1px solid #555;">
                    <option value="asc">Ascending</option>
                    <option value="desc">Descending</option>
                </select>
                <button onclick="loadItems()">Apply Sort</button>
            </div>

            <div id="todoMessage" class="message hidden"></div>

            <div id="itemsList" class="items-list"></div>
        </div>
    </div>

    <script>
        const API_URL = 'http://localhost:5000';
        let currentUser = null;

        function showMessage(elementId, message, isError = false) {
            const element = document.getElementById(elementId);
            element.textContent = message;
            element.className = isError ? 'message' : 'message';
            element.classList.remove('hidden');
            setTimeout(() => {
                element.classList.add('hidden');
            }, 5000);
        }

        async function register() {
            const email = document.getElementById('registerEmail').value;
            const password = document.getElementById('registerPassword').value;

            if (!email || !password) {
                showMessage('authMessage', 'Please fill in all fields', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/register`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('authMessage', 'Registration successful! Please login.');
                    document.getElementById('registerEmail').value = '';
                    document.getElementById('registerPassword').value = '';
                } else {
                    showMessage('authMessage', data.error || 'Registration failed', true);
                }
            } catch (error) {
                showMessage('authMessage', 'Error: ' + error.message, true);
            }
        }

        async function login() {
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;

            if (!email || !password) {
                showMessage('authMessage', 'Please fill in all fields', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/login`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({ email, password })
                });

                const data = await response.json();
                if (data.success) {
                    currentUser = data.user;
                    document.getElementById('userInfo').textContent = `Logged in as: ${currentUser.email}`;
                    document.getElementById('authSection').classList.add('hidden');
                    document.getElementById('todoSection').classList.remove('hidden');
                    loadItems();
                } else {
                    showMessage('authMessage', data.error || 'Login failed', true);
                }
            } catch (error) {
                showMessage('authMessage', 'Error: ' + error.message, true);
            }
        }

        function logout() {
            currentUser = null;
            document.getElementById('authSection').classList.remove('hidden');
            document.getElementById('todoSection').classList.add('hidden');
            document.getElementById('loginEmail').value = '';
            document.getElementById('loginPassword').value = '';
            document.getElementById('itemsList').innerHTML = '';
        }

        async function createItem() {
            const title = document.getElementById('itemTitle').value;
            const description = document.getElementById('itemDescription').value;
            const status = document.getElementById('itemStatus').value;

            if (!title) {
                showMessage('todoMessage', 'Title is required', true);
                return;
            }

            if (!currentUser) {
                showMessage('todoMessage', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/post_item`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUser.id
                    },
                    body: JSON.stringify({ title, description, status })
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('todoMessage', 'Item created successfully');
                    document.getElementById('itemTitle').value = '';
                    document.getElementById('itemDescription').value = '';
                    loadItems();
                } else {
                    showMessage('todoMessage', data.error || 'Failed to create item', true);
                }
            } catch (error) {
                showMessage('todoMessage', 'Error: ' + error.message, true);
            }
        }

        async function loadItems() {
            if (!currentUser) {
                showMessage('todoMessage', 'Please login first', true);
                return;
            }

            try {
                const sortBy = document.getElementById('sortBy').value || 'id';
                const sortOrder = document.getElementById('sortOrder').value || 'asc';
                
                const response = await fetch(`${API_URL}/items?sort_by=${sortBy}&sort_order=${sortOrder}`, {
                    headers: {
                        'X-User-ID': currentUser.id
                    }
                });
                const data = await response.json();
                
                if (data.success) {
                    displayItems(data.items);
                } else {
                    showMessage('todoMessage', 'Failed to load items', true);
                }
            } catch (error) {
                showMessage('todoMessage', 'Error: ' + error.message, true);
            }
        }

        let editingItemId = null;

        function displayItems(items) {
            const itemsList = document.getElementById('itemsList');
            itemsList.innerHTML = '';

            if (items.length === 0) {
                itemsList.innerHTML = '<div class="item">No items found</div>';
                return;
            }

            items.forEach(item => {
                const itemDiv = document.createElement('div');
                itemDiv.className = 'item';
                itemDiv.id = `item-${item.id}`;
                
                if (editingItemId === item.id) {
                    // Show edit form
                    itemDiv.innerHTML = `
                        <strong>Edit Item</strong><br><br>
                        <label style="display: block; margin-top: 10px;">Title:</label>
                        <input type="text" id="edit-title-${item.id}" value="${item.title || ''}" style="width: 100%; padding: 10px; margin-bottom: 10px; background-color: #333; color: white; border: 1px solid #555;">
                        
                        <label style="display: block; margin-top: 10px;">Description:</label>
                        <input type="text" id="edit-description-${item.id}" value="${item.description || ''}" style="width: 100%; padding: 10px; margin-bottom: 10px; background-color: #333; color: white; border: 1px solid #555;">
                        
                        <label style="display: block; margin-top: 10px;">Status:</label>
                        <select id="edit-status-${item.id}" style="width: 100%; padding: 10px; margin-bottom: 10px; background-color: #333; color: white; border: 1px solid #555;">
                            <option value="ToDo" ${item.status === 'ToDo' ? 'selected' : ''}>ToDo</option>
                            <option value="InProgress" ${item.status === 'InProgress' ? 'selected' : ''}>InProgress</option>
                            <option value="Done" ${item.status === 'Done' ? 'selected' : ''}>Done</option>
                        </select>
                        
                        <button onclick="saveItem('${item.id}')">Save</button>
                        <button onclick="cancelEdit()">Cancel</button>
                    `;
                } else {
                    // Show item display
                    itemDiv.innerHTML = `
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Title:</label>
                            <div>${item.title || 'No title'}</div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Description:</label>
                            <div>${item.description || 'No description'}</div>
                        </div>
                        <div style="margin-bottom: 10px;">
                            <label style="display: block; font-weight: bold; margin-bottom: 5px;">Status:</label>
                            <div>${item.status || 'N/A'}</div>
                        </div>
                        <button onclick="editItem('${item.id}')">Edit</button>
                        <button onclick="deleteItem('${item.id}')">Delete</button>
                    `;
                }
                itemsList.appendChild(itemDiv);
            });
        }

        function editItem(itemId) {
            editingItemId = itemId;
            loadItems();
        }

        function cancelEdit() {
            editingItemId = null;
            loadItems();
        }

        async function saveItem(itemId) {
            if (!currentUser) {
                showMessage('todoMessage', 'Please login first', true);
                return;
            }

            const title = document.getElementById(`edit-title-${itemId}`).value;
            const description = document.getElementById(`edit-description-${itemId}`).value;
            const status = document.getElementById(`edit-status-${itemId}`).value;

            if (!title) {
                showMessage('todoMessage', 'Title is required', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/items/${itemId}`, {
                    method: 'PUT',
                    headers: {
                        'Content-Type': 'application/json',
                        'X-User-ID': currentUser.id
                    },
                    body: JSON.stringify({ title, description, status })
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('todoMessage', 'Item updated successfully');
                    editingItemId = null;
                    loadItems();
                } else {
                    showMessage('todoMessage', data.error || 'Failed to update item', true);
                }
            } catch (error) {
                showMessage('todoMessage', 'Error: ' + error.message, true);
            }
        }

        async function deleteItem(itemId) {
            if (!confirm('Are you sure you want to delete this item?')) {
                return;
            }

            if (!currentUser) {
                showMessage('todoMessage', 'Please login first', true);
                return;
            }

            try {
                const response = await fetch(`${API_URL}/items/${itemId}`, {
                    method: 'DELETE',
                    headers: {
                        'X-User-ID': currentUser.id
                    }
                });

                const data = await response.json();
                if (data.success) {
                    showMessage('todoMessage', 'Item deleted successfully');
                    loadItems();
                } else {
                    showMessage('todoMessage', data.error || 'Failed to delete item', true);
                }
            } catch (error) {
                showMessage('todoMessage', 'Error: ' + error.message, true);
            }
        }
    </script>
</body>
</html>
